<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="client-display-basic.html">
<link rel="import" href="client-display-advanced.html">
<link rel="import" href="../../paper-item/paper-item.html">
<link rel="import" href="../../paper-shadow/paper-shadow.html">
<link rel="import" href="../../ajax-form/ajax-form.html">

<polymer-element name="client-display" attributes="locale mode data">

  <template>
    <link rel="stylesheet" href="client-display.css">

    <!-- Error on sending data -->
    <div id="error">
      <paper-shadow>
        <paper-item class="client-error" noink>{{errorMessage}}</paper-item>
      </paper-shadow>
    </div>

    <!--  Display  -->
    <template if="{{ mode === 'basic' }}">
      <client-display-basic id="basic" resources="{{resources}}" data="{{data}}" locale="{{locale}}"></client-display-basic>
    </template>
    <template if="{{ mode === 'advanced' }}">
      <client-display-advanced id="advanced" resources="{{resources}}" data="{{data}}" locale="{{locale}}"></client-display-advanced>
    </template>

    <!--  Button  -->
    <paper-button class="client-submit" on-click="{{sendData}}">{{ data.clientId == null ? resources.create : resources.update }}</paper-button>

    <!-- Hidden Form -->
    <form id="form" is="ajax-form" method="post" action="{{ data.clientId == null ? config.clientCreateUri : config.clientUpdateUri }}">
      <div id="formData"></div>
    </form>
  </template>

  <script src="configuration.js"></script>
  <!--<script src="input/validator.js"></script>-->

  <script>
    (function() {
      Polymer({

        //--------------------------------
        // Public parameters.
        //--------------------------------

        /**
         * The language information in which this component is represented.
         *
         * @attribute locale
         * @type string
         * @default 'en'
         */
        locale: 'en',

        /**
         * The mode of this element.
         * This can be 'basic' or 'advanced'.
         *
         * @attribute mode
         * @type string
         * @default 'basic'
         */
        mode: 'basic',

        /**
         * The data regarding a client application.
         *
         * @attribute data
         * @type Object
         * @default []
         */
        data: [],

        //--------------------------------
        // Private Parameters.
        //--------------------------------

        /**
         * The resources representing this elements in this component
         * such as the names of the properties.
         * This value will vary depending on the 'locale' value.
         *
         * @attribute resources
         * @type Object
         * @default resources_en
         */
        resources: resources_en,

        /**
         * The configuration of creating and updating client applications.
         * This includes information about the urls
         * for creating and updating client applications.
         *
         * @attribute config
         * @type Object
         * @default config
         */
        config: configuration,

        /**
         * The error message about creating or updating client applications.
         *
         * @attribute errorMessage
         * @type string
         * @default ''
         */
        errorMessage: '',

        ready: function() {
          // Set up the resoruces.
          this.setUpResources();

          // Set the event listeners to the form.
          this.setFormEventListeners();

          // Hide the error part.
          this.$.error.style.visibility = 'hidden';
        },

        setUpResources: function () {
          // Set the resource depending on the given locale information.
          switch (this.locale) {
            case 'ja':
              this.resources = resources_ja;
              break;

            default:
              this.locale = 'en';
              this.resources = resources_en;
              break;
          }
        },

        setFormEventListeners: function() {
          var that = this;

          // On invalid data.
          this.$.form.addEventListener('invalid', function (e) {
            that.showError(e)
          });

          // On successfully submitted.
          this.$.form.addEventListener('submitted', function (e) {
          });
        },

        sendData: function() {
          // Validate the data.
          try
          {
            validate(this.data);
          }
          catch (e)
          {
            this.showError(e);

            return;
          }

          // Extract non empty data.
          var nonEmptyData = this.extractNonEmptyData();

          // Send the data.
          this.doSendData(nonEmptyData);
        },

        extractNonEmptyData: function () {
          var nonEmptyData = {};

          for (var key in this.data)
          {
            if (isEmpty(this.data[key]) === false)
            {
              nonEmptyData[key] = this.data[key];
            }
          }

          return nonEmptyData;
        },

        doSendData: function (data) {
          // Remove the old data associated with the form.
          this.removeOldFormData();

          // Set the data to the form.
          this.setFormData(data);

          // Submit the form.
          this.$.form.submit();
        },

        removeOldFormData: function () {
          while (this.$.formData.firstChild) {
            this.$.formData.removeChild(this.$.formData.firstChild);
          }
        },

        setFormData: function (data) {
          for (var key in data)
          {
            if (data.hasOwnProperty(key))
            {
              var hiddenField = document.createElement('input');

              hiddenField.setAttribute('type', 'hidden');
              hiddenField.setAttribute('name', key);
              hiddenField.setAttribute('value', data[key]);

              this.$.formData.appendChild(hiddenField);
            }
          }
        },

        showError: function (data) {
          // Set the data.
          this.errorMessage = data;

          // Show the error.
          this.$.error.style.visibility = 'visible';

          // Scroll back to the error.
          location.href = '#';
          location.href = '#error';
        }

      });
    }) ();
  </script>

</polymer-element>